<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Secure Inventory Scanner V2</title>
  <style>
    body {
      margin: 0;
      font-family: 'Arial', sans-serif;
      background: #f5f5f5;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    h2 {
      margin-top: 10px;
    }
    #scannerSection {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0px 4px 10px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 400px;
      text-align: center;
      margin-top: 20px;
    }
    #reader {
      width: 100%;
      margin-top: 10px;
    }
    #status {
      margin-top: 20px;
      padding: 10px;
      border-radius: 8px;
      font-weight: bold;
      display: none;
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
  </style>
</head>
<body>
  <h2>Secure Inventory Scanner</h2>

  <div id="scannerSection">
    <div id="reader"></div>
    <div id="status"></div>
  </div>

  <script src="https://unpkg.com/@zxing/library@0.18.6/umd/index.min.js"></script>
  <script>
    const securityPrefix = "X9COMP";
    const scannedBarcodes = new Set();
    const googleScriptURL = "https://script.google.com/macros/s/AKfycbyoOG9xAJpZg2uauSq-HcEJeNnRp82735H4GPniwi67RhnEq-m2JfUxSA7bm2ehVjho/exec"; // YOUR Web App URL

    function showStatus(message, isSuccess) {
      const statusDiv = document.getElementById('status');
      statusDiv.innerText = message;
      statusDiv.className = isSuccess ? 'success' : 'error';
      statusDiv.style.display = 'block';

      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 1500);
    }

    function startScanner() {
      const codeReader = new ZXing.BrowserBarcodeReader();
      console.log('Starting scanner...');

      codeReader.decodeFromVideoDevice(undefined, 'reader', (result, err) => {
        if (result) {
          const text = result.getText();
          console.log('Scanned:', text);

          if (!text.startsWith(securityPrefix)) {
            showStatus("Invalid Barcode ❌", false);
            return;
          }

          if (scannedBarcodes.has(text)) {
            showStatus("Already Scanned This Session ❌", false);
            return;
          }

          scannedBarcodes.add(text);
          showStatus("Scan Successful ✅", true);

          const dateObj = new Date();
          const date = dateObj.toISOString().split('T')[0];
          const time = dateObj.toTimeString().split(' ')[0];

          const scanData = {
            barcodeData: text,
            date: date,
            time: time
          };

          fetch(googleScriptURL, {
            method: "POST",
            mode: "no-cors",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify(scanData)
          }).then(() => {
            console.log('Logged to Google Sheets ✅');
          }).catch(err => {
            console.error('Error sending to Google Sheets ❌', err);
          });
        }
      });
    }

    // Start scanner immediately
    startScanner();
  </script>
</body>
</html>
