<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Secure Inventory Scanner V2</title>
  <style>
    body {
      margin: 0;
      font-family: 'Arial', sans-serif;
      background: #f5f5f5;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    h2 {
      margin-top: 10px;
    }
    #sessionForm, #scannerSection {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0px 4px 10px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 400px;
      text-align: center;
      margin-top: 20px;
    }
    input, select, button {
      margin: 10px 0;
      padding: 10px;
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    button {
      background: #007bff;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
    #reader {
      width: 100%;
      margin-top: 10px;
    }
    #status {
      margin-top: 20px;
      padding: 10px;
      border-radius: 8px;
      font-weight: bold;
      display: none;
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
  </style>
</head>
<body>
  <h2>Secure Inventory Scanner</h2>

  <!-- Session Start Form -->
  <div id="sessionForm">
    <input type="text" id="scannerName" placeholder="Who is scanning? (Your Name)">
    <input type="text" id="productName" placeholder="What product is being scanned?">
    <button id="startSessionBtn">Start Scanning</button>
  </div>

  <!-- Barcode Scanner Section -->
  <div id="scannerSection" class="hidden">
    <div id="reader"></div>
    <div id="status"></div>
  </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/@zxing/library@0.18.6/umd/index.min.js"></script>
  <script>
    const securityPrefix = "X9COMP";
    const scannedBarcodes = new Set();
    const googleScriptURL = "PASTE_YOUR_GOOGLE_SCRIPT_URL_HERE"; // UPDATE THIS!

    let scannerName = "";
    let productName = "";

    document.getElementById('startSessionBtn').addEventListener('click', () => {
      scannerName = document.getElementById('scannerName').value.trim();
      productName = document.getElementById('productName').value.trim();

      if (!scannerName || !productName) {
        alert('Please fill both fields!');
        return;
      }

      document.getElementById('sessionForm').classList.add('hidden');
      document.getElementById('scannerSection').classList.remove('hidden');

      startScanner();
    });

    function showStatus(message, isSuccess) {
      const statusDiv = document.getElementById('status');
      statusDiv.innerText = message;
      statusDiv.className = isSuccess ? 'success' : 'error';
      statusDiv.style.display = 'block';

      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 1500);
    }

    function startScanner() {
      const codeReader = new ZXing.BrowserBarcodeReader();
      console.log('Starting scanner...');

      codeReader.decodeFromVideoDevice(undefined, 'reader', (result, err) => {
        if (result) {
          const text = result.getText();
          console.log('Scanned:', text);

          if (scannedBarcodes.has(text)) {
            showStatus("Already Scanned ❌", false);
            return;
          }

          if (!text.startsWith(securityPrefix)) {
            showStatus("Invalid Barcode ❌", false);
            return;
          }

          scannedBarcodes.add(text);
          showStatus("Scan Successful ✅", true);

          const dateObj = new Date();
          const date = dateObj.toISOString().split('T')[0];
          const time = dateObj.toTimeString().split(' ')[0];

          // Send data to Google Sheets
          const scanData = {
            scannerName: scannerName,
            productName: productName,
            barcodeData: text,
            date: date,
            time: time
          };

          fetch(googleScriptURL, {
            method: "POST",
            mode: "no-cors",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify(scanData)
          }).then(() => {
            console.log('Logged to Google Sheets ✅');
          }).catch(err => {
            console.error('Error sending to Google Sheets ❌', err);
          });
        }
      });
    }
  </script>
</body>
</html>
