<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Secure Barcode Scanner (Fixed)</title>
  <style>
    body {
      margin: 0;
      font-family: 'Arial', sans-serif;
      background: #f5f5f5;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    h2 {
      margin-top: 10px;
    }
    #reader {
      width: 100%;
      max-width: 400px;
      margin-top: 20px;
      border-radius: 12px;
      box-shadow: 0px 4px 10px rgba(0,0,0,0.1);
      background: white;
    }
    #status {
      margin-top: 20px;
      padding: 10px;
      border-radius: 8px;
      font-weight: bold;
      display: none;
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
  </style>
</head>
<body>
  <h2>Secure Barcode Scanner</h2>

  <div id="reader"></div>
  <div id="status"></div>

  <script src="https://unpkg.com/html5-qrcode@2.3.7/html5-qrcode.min.js"></script>

  <script>
    const securityPrefix = "X9COMP";
    const scannedBarcodes = new Set();
    const googleScriptURL = "https://script.google.com/macros/s/AKfycbyoOG9xAJpZg2uauSq-HcEJeNnRp82735H4GPniwi67RhnEq-m2JfUxSA7bm2ehVjho/exec";

    function showStatus(message, isSuccess) {
      const statusDiv = document.getElementById('status');
      statusDiv.innerText = message;
      statusDiv.className = isSuccess ? 'success' : 'error';
      statusDiv.style.display = 'block';

      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 1500);
    }

    const html5QrCode = new Html5Qrcode("reader");

    const config = {
      fps: 15,
      qrbox: { width: 250, height: 100 },
      formatsToSupport: [ Html5QrcodeSupportedFormats.CODE_128, Html5QrcodeSupportedFormats.CODE_39, Html5QrcodeSupportedFormats.EAN_13 ],
      rememberLastUsedCamera: true
    };

    Html5Qrcode.getCameras().then(devices => {
      if (devices && devices.length) {
        let cameraId = devices[0].id; // back camera by default

        html5QrCode.start(
          cameraId,
          config,
          (decodedText, decodedResult) => {
            console.log("Scanned:", decodedText);

            if (!decodedText.startsWith(securityPrefix)) {
              showStatus("Invalid Barcode ❌", false);
              return;
            }

            if (scannedBarcodes.has(decodedText)) {
              showStatus("Already Scanned This Session ❌", false);
              return;
            }

            scannedBarcodes.add(decodedText);
            showStatus("Scan Successful ✅", true);

            const dateObj = new Date();
            const date = dateObj.toISOString().split('T')[0];
            const time = dateObj.toTimeString().split(' ')[0];

            const scanData = {
              barcodeData: decodedText,
              date: date,
              time: time
            };

            fetch(googleScriptURL, {
              method: "POST",
              mode: "no-cors",
              headers: {
                "Content-Type": "application/json"
              },
              body: JSON.stringify(scanData)
            }).then(() => {
              console.log('Logged to Google Sheets ✅');
            }).catch(err => {
              console.error('Error sending to Google Sheets ❌', err);
            });
          },
          (errorMessage) => {
            // ignore errors
          }
        );
      } else {
        alert("No camera found on this device ❌");
      }
    }).catch(err => {
      console.error('Camera Access Error:', err);
      alert("Camera access issue ❌");
    });
  </script>
</body>
</html>
